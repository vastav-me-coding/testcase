import os
import json
import time
import requests
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy import text
from df_database_models.db_conn import get_rds_db_session, get_as400_db_session
from df_database_models.models import Payment,Payment_Type,Payment_Status,Invoice, Source_System
from df_database_models.db_utils import  generate_uuid, convert_timestamps, generate_uuid, query_update_dict, get_record, call_sp
from secrets_manager import get_secret
from datetime import datetime
import pandas as pd
import asyncio
from adf_pyutils.clm_wrapper import common_logger

print("Class job is executing")

pnc_db = os.environ['RDS_DB_NAME']

## Fetch SQS producer Parameters from aws secret manager
def init_sp(source_transaction_id=None):
    if source_transaction_id:
        sqs_producer_secret = json.loads(get_secret(
                secret_name=os.environ["SQS_PRODUCER_SECRET_ID"], region_name=os.environ["AWS_REGION"]))
        sqs_producer_access_key = sqs_producer_secret["access_key"]
        sqs_policy_update_url = os.environ["SQS_POLICY_UPDATE_URL"]
        call_sp(sqs_policy_update_url,sqs_producer_access_key, source_transaction_id)

async def log_msg(func,**kwargs):
    await asyncio.to_thread(func,**kwargs)

def call_session_engine(source_system=None, database_name=None):
 
    rds_secret_name=os.environ["RDS_SECRETS_MANAGER_ID"]
    region_name=os.environ["AWS_REGION"]
    rds_host_nm=os.environ['RDS_HOST']
 
    if database_name == 'ref_data':
        rds_db_nm=os.environ['RDS_REF_DB_NAME']
    elif database_name == 'mdm_raw':
        rds_db_nm=os.environ['RDS_RAW_DB_NAME']
    elif database_name == 'mdm_refined':
        rds_db_nm=os.environ['RDS_REFINED_DB_NAME']
    else:
        rds_db_nm=os.environ['RDS_DB_NAME']
 
 
    if source_system.lower() == 'as400_aff':
        #Calling the as400 engine to establish a connection to PAS Source System - as400_AFF
        as400_secret_name=os.environ["AS400_AFF_SECRETS_MANAGER_ID"]
        as400_engine=get_as400_db_session(as400_secret_name, region_name)
        return as400_engine
 
    elif source_system.lower() == 'as400_kkins':
        #Calling the as400 engine to establish a connection to PAS Source System - as400_AUM
        as400_secret_name=os.environ["AS400_KKINS_SECRETS_MANAGER_ID"]
        as400_engine=get_as400_db_session(as400_secret_name, region_name)
        return as400_engine
 
    if database_name:
        #Calling the Db session Object to establish a connection to Data Foundation Schema
        session=get_rds_db_session(rds_secret_name,region_name,rds_host_nm,rds_db_nm)
 
        return session

session_db = call_session_engine(database_name=pnc_db)
as400_engine_aff = call_session_engine(source_system='as400_aff')
as400_engine_kkins = call_session_engine(source_system='as400_kkins')

# lookup into as400 aff
def lookup_as400(config=None, id=None):

    source_system = config['source_system']
    if source_system:
        if(source_system.lower() == 'as400_affprd'):
                df = pd.read_sql(f"""
                    SELECT 
                    ar.customer_number || '-' || ar.effective_date || '-' || cast(ar.invoice_no AS varchar(10)) AS source_invoice_id
                    ,p.source_payment_type
                    -- ,NULL AS source_payment_status
                    ,CASE WHEN ar.due_amount = 0 THEN ar.amount_paid ELSE NULL END AS payment_amount
                    ,p.payment_date
                    ,'AS400_AFFPRD' AS source_system
                    FROM 
                    (SELECT  ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0') AS customer_number,INVOICE_NO
                    ,MAX(CASE	WHEN length(trim(CASH_DATE_6)) = 1 THEN NULL
                     		WHEN length(trim(CASH_DATE_6)) =  5 THEN '20'||substring(trim(CASH_DATE_6),4,2) || '0' ||
                     		substring(trim(CASH_DATE_6),1,1) || substring(trim(CASH_DATE_6),2,2)   
                     		ELSE '20'||substring(trim(CASH_DATE_6),5,2) || 
                     		substring(trim(CASH_DATE_6),1,2) || substring(trim(CASH_DATE_6),3,2) 
                     		END) AS payment_date 
                    ,MAX(PAYMENT_TYPE) AS source_payment_type
                    FROM ADGDTAPR.""U.PAYMNT"" p 
                    GROUP BY ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0'),INVOICE_NO ) AS p 
                    INNER JOIN 
                    (
                    SELECT customer_number,invoice_no,CASE	WHEN length(trim(EFFECTIVE_DATE_6)) = 1 THEN NULL
                     		WHEN length(trim(EFFECTIVE_DATE_6)) =  5 THEN '20'||substring(trim(EFFECTIVE_DATE_6),4,2) || '0' ||
                     		substring(trim(EFFECTIVE_DATE_6),1,1) || substring(trim(EFFECTIVE_DATE_6),2,2)   
                     		ELSE '20'||substring(trim(EFFECTIVE_DATE_6),5,2) || 
                     		substring(trim(EFFECTIVE_DATE_6),1,2) || substring(trim(EFFECTIVE_DATE_6),3,2) 
                     		END AS effective_date ,due_amount,amount_paid FROM
                     		(
                    SELECT ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0') AS customer_number,INVOICE_NO ,EFFECTIVE_DATE_6
                    ,SUM((PREMIUM+AMOUNT_ASSURED_PAID) - (CASH_ALLOCATED+RETURN_PREMIUM_CHG)) AS due_amount
                    ,SUM(PREMIUM) AS amount_paid
                    FROM ADGDTAPR.""U.ARFILE""
                    GROUP BY ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0') ,INVOICE_NO,EFFECTIVE_DATE_6
                    ) WHERE due_amount = 0
                    ) ar 
                    ON ar.customer_number = p.customer_number AND p.invoice_no = ar.invoice_no
                    --WHERE ar.customer_number || '-' || ar.effective_date || '-' || cast(ar.invoice_no AS varchar(10)) =  {id}
                    """, con=as400_engine)
        elif(source_system.lower() == 'as400_attorney'):
                    df = pd.read_sql(f"""
                                    SELECT CAST(NULL AS varchar(255)) AS df_payment_id
                                    ,ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0') AS source_payment_id
                                    ,CAST(NULL AS varchar(255)) AS df_invoice_id --INVOICE_NO
                                    ,CAST(NULL AS varchar(255)) AS df_payment_type_id
                                    ,CAST(NULL AS varchar(255)) AS df_payment_status_id
                                    ,MAX(PAYMENT_TYPE) AS source_payment_type
                                    ,CAST(NULL AS varchar(255)) AS source_payment_status
                                    ,SUM(CASH_ENTERED) AS payment_amount
                                    ,MAX(CASE	WHEN length(trim(CASH_DATE_6)) = 1 THEN NULL
                                     		WHEN length(trim(CASH_DATE_6)) =  5 THEN '20'||substring(trim(CASH_DATE_6),4,2) || '0' ||
                                     		substring(trim(CASH_DATE_6),1,1) || substring(trim(CASH_DATE_6),2,2)   
                                     		ELSE '20'||substring(trim(CASH_DATE_6),5,2) || 
                                     		substring(trim(CASH_DATE_6),1,2) || substring(trim(CASH_DATE_6),3,2) 
                                     		END) AS payment_date
                                    ,CAST(NULL AS varchar(255)) AS df_source_system_id
                                    ,CAST(NULL AS timestamp) AS created_date
                                    ,CAST(NULL AS timestamp) AS modified_date
                                    FROM S36OTH.""U.PAYMNT"" p WHERE BRANCH_NO = '18' AND  (ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0')) IS NOT NULL
                                    AND LENGTH((ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0'))) > 1
                                    GROUP BY ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0'),INVOICE_NO 
                                    where ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0') = {id}
                                     """, con=as400_engine)
        elif(source_system.lower() == 'as400_kkins'):
                df = pd.read_sql(f"""
                    SELECT inv.source_payment_id,inv.source_invoice_id,inv.transaction_id
                    ,inv.order_date , inv.total_amount_due, inv.due_date
                    ,CASE WHEN inv.total_amount_due = pay.payment_amount THEN 'Closed' ELSE 'Open' END AS invoice_status
                    ,pay.payment_amount,pay.payment_date FROM 
                    (SELECT DISTINCT 
                    f0.QBDOC AS source_payment_id,
                    f0.QBDOC AS source_invoice_id,
                    (f0.QB$PCD||'-'||f0.QB$CMP||'-'||f0.QB$PFX||'-'||f0.QB$NBR||'-'||f0.QB$SFX||'-'||f0.QB$END) AS transaction_id,
                    TO_CHAR(
                      DATE(
                        CASE
                          WHEN SUBSTR(QBDIVJ, 1, 1) != '1'
                            THEN '19' || SUBSTR(QBDIVJ, 1, 2) || '-01-01'
                            ELSE '20' || SUBSTR(QBDIVJ, 2, 2) || '-01-01'
                        END
                      )
                      +
                      CASE
                        WHEN LENGTH(TRIM(QBDIVJ)) = 5
                          THEN CAST(SUBSTR(QBDIVJ, 3, 3) AS INT) - 1
                          ELSE CAST(SUBSTR(QBDIVJ, 4, 3) AS INT) - 1
                      END DAYS
                    , 'YYYYMMDD') AS order_date,
                     sum(f11.RPAG) AS total_amount_due,
                     TO_CHAR(
                      DATE(
                        CASE
                          WHEN SUBSTR(f11.RPDDJ, 1, 1) != '1'
                            THEN '19' || SUBSTR(f11.RPDDJ, 1, 2) || '-01-01'
                            ELSE '20' || SUBSTR(f11.RPDDJ, 2, 2) || '-01-01'
                        END
                      )
                      +
                      CASE
                        WHEN LENGTH(TRIM(f11.RPDDJ)) = 5
                          THEN CAST(SUBSTR(f11.RPDDJ, 3, 3) AS INT) - 1
                          ELSE CAST(SUBSTR(f11.RPDDJ, 4, 3) AS INT) - 1
                      END DAYS
                    , 'YYYYMMDD') AS due_date
                    FROM SLEDTA.F55300 AS f0
                    JOIN SLEDTA.F0311 AS f11 ON f11.RPDOC = f0.QBDOC
                    WHERE TRIM(RPDCTM) = '' AND RPDMTJ = 0 
                    -- AND (f0.QB$CMP||f0.QB$PFX||f0.QB$NBR||f0.QB$SFX) = '9RAIA0000442499400'
                    GROUP BY (f0.QB$PCD||'-'||f0.QB$CMP||'-'||f0.QB$PFX||'-'||f0.QB$NBR||'-'||f0.QB$SFX||'-'||f0.QB$END),f0.QBDOC,QBDIVJ,f11.RPDDJ ) AS inv
                    LEFT JOIN 
                    (
                    SELECT 
                    f0.QBDOC AS source_invoice_id,
                    f0.QBDOC AS invoice_number,
                    (f0.QB$PCD||'-'||f0.QB$CMP||'-'||f0.QB$PFX||'-'||f0.QB$NBR||'-'||f0.QB$SFX||'-'||f0.QB$END) AS transaction_id,
                    -- NULL AS payment_type,
                    -- NULL AS payment_status,
                    ABS(sum(f11.RPAG)) AS payment_amount,
                    TO_CHAR(
                      DATE(
                        CASE
                          WHEN SUBSTR(f11.RPDMTJ, 1, 1) != '1'
                            THEN '19' || SUBSTR(f11.RPDMTJ, 1, 2) || '-01-01'
                            ELSE '20' || SUBSTR(f11.RPDMTJ, 2, 2) || '-01-01'
                        END
                      )
                      +
                      CASE
                        WHEN LENGTH(TRIM(f11.RPDMTJ)) = 5
                          THEN CAST(SUBSTR(f11.RPDMTJ, 3, 3) AS INT) - 1
                          ELSE CAST(SUBSTR(f11.RPDMTJ, 4, 3) AS INT) - 1
                      END DAYS
                    , 'YYYYMMDD') AS payment_date
                    FROM SLEDTA.F55300 AS f0
                    JOIN SLEDTA.F0311 AS f11 ON f11.RPDOC = f0.QBDOC
                    WHERE TRIM(RPDCTM) != '' AND RPDMTJ > 0  
                    -- AND (f0.QB$CMP||f0.QB$PFX||f0.QB$NBR||f0.QB$SFX) = '9RAIA0000442499400'
                    GROUP BY (f0.QB$PCD||'-'||f0.QB$CMP||'-'||f0.QB$PFX||'-'||f0.QB$NBR||'-'||f0.QB$SFX||'-'||f0.QB$END),f0.QBDOC,QBDIVJ,f11.RPDDJ,RPDMTJ
                    ) AS pay 
                    ON inv.source_invoice_id = pay.invoice_number
                    where inv.source_payment_id= {id}
                    """, con=as400_engine)
    else:
        df=None

    if(len(df)>0):
        return df.to_dict('records')[0]
    else:
        return None

async def consume_lambda(config=None):
    asyncio.create_task(log_msg(common_logger,log_messages='consume lambda function invoking'))
    now = datetime.now()
    start_timestamp = datetime.timestamp(now)
    asyncio.create_task(log_msg(common_logger,log_messages=f'Processing to DB @ {now} | {datetime.timestamp(now)}'))

    try:
        asyncio.create_task(log_msg(common_logger,log_messages='Config',api_response=convert_timestamps(config)))
        config_dicts = config if type(config) is dict else json.loads(str(config))
        if type(config_dicts) == list:
            pass
        else:
            config_dicts = [config_dicts] # Ensure config_dicts is a list
        for config_dict in config_dicts:
            id = config_dict['payment'] # Get the payment from config data 
            source_system = config_dict['source_system'].lower()
            if(id):
                fk_flag = 1
                print("Calling call_session_engine Function ") 
                global session, as400_engine 
                if source_system == 'as400_aff':
                    session = session_db
                    as400_engine = as400_engine_aff
                elif source_system == 'as400_kkins':
                    session = session_db
                    as400_engine = as400_engine_kkins

                payment_dict = lookup_as400(config_dict, id) #define dict for lookup data
                
                if(payment_dict):
                    asyncio.create_task(log_msg(common_logger,log_messages=f'Initial {source_system} payment dict:',api_response=convert_timestamps(payment_dict)))

                    #Fetch Source SyStem Id from Data Foundation
                    source_system = payment_dict.get("source_system")
                    source_system_record = (query.first() if (query := get_record(session,model=Source_System,column_name='source_system',value=source_system)) is not None else None)
                    if source_system_record:
                        payment_dict['df_source_system_id'] = source_system_record.df_source_system_id

                    #Fetch Payment Type Id from Data Foundation
                    payment_type = payment_dict.get("payment_type")
                    payment_type_record = (query.first() if (query := get_record(session,model=Payment_Type,column_name='payment_type',value=payment_type)) is not None else None)
                    if payment_type_record:
                        payment_dict['df_payment_type_id'] = payment_type_record.df_payment_type_id

                    #Fetch Payment status Id from Data Foundation
                    payment_status = payment_dict.get("payment_status")
                    payment_status_record = (query.first() if (query := get_record(session,model=Payment_Status,column_name='payment_status',value=payment_status)) is not None else None)
                    if payment_status_record:
                        payment_dict['df_payment_status_id'] = payment_status_record.df_payment_status_id

                    #Fetch invoice Id from Data Foundation
                    invoice = payment_dict.get("invoice")
                    invoice_record = (query.first() if (query := get_record(session,model=Invoice,column_name='invoice',value=invoice)) is not None else None)
                    if invoice_record:
                        payment_dict['df_invoice_id'] = invoice_record.df_invoice_id

                   
                    #Assign a variable to invoice_id, payment_id,payment_status_id,payment_type_id and source_system_id from Dictionary Object
                    df_invoice_id = payment_dict.get("df_invoice_id") 
                    df_payment_id = payment_dict.get("df_payment_id") 
                    df_source_system_id = payment_dict.get("df_source_system_id") 
                    df_payment_status_id = payment_dict.get("df_payment_status_id")
                    df_payment_type_id = payment_dict.get("df_payment_type_id")

                    #Fetch payment  data from Data Foundation
                    payment_record = get_record(session,model=Payment,column_name='df_payment_id',value=df_payment_id,df_source_system_id=df_source_system_id)

                    self_payment_status = (payment_status_record.first() if payment_status_record is not None else None)
                    self_payment_type = (payment_type_record.first() if payment_type_record is not None else None)                    
                    self_invoice = (invoice_record.first() if invoice_record is not None else None)
                    self_payment = (payment_record.first() if payment_record is not None else None)
                    

                    asyncio.create_task(log_msg(common_logger,log_messages=f'self payment status - {self_payment_status}'))
                    asyncio.create_task(log_msg(common_logger,log_messages=f'self payment type - {self_payment_type}'))
                    asyncio.create_task(log_msg(common_logger,log_messages=f'invoice - {self_invoice}'))
                    asyncio.create_task(log_msg(common_logger,log_messages=f'self payment - {self_payment}'))
                    asyncio.create_task(log_msg(common_logger,log_messages=f'Changed {source_system} payment dict:',api_response=convert_timestamps(payment_dict)))
                    
                    fk_flag = 1
                    if(self_invoice is None):
                        asyncio.create_task(log_msg(common_logger,log_messages='Invoice does not exist in Data Foundation'))
                        payment_dict['df_invoice_id'] = generate_uuid(
                            str(payment_dict['source_invoice_id'] or '') + 
                            str(payment_dict['invoice_number'] or ''), 
                            df_invoice_id
                        )
                        session.execute(text("SET FOREIGN_KEY_CHECKS = 0;"))
                        fk_flag = 0
                        asyncio.create_task(log_msg(common_logger,log_messages='FK disabled'))
                    else:
                        asyncio.create_task(log_msg(common_logger,log_messages='invoice exists in Data Foundation'))
                        payment_dict['df_invoice_id']=self_invoice.df_invoice_id

                    if(self_payment_type is None):
                        asyncio.create_task(log_msg(common_logger,log_messages='payment type does not exist in Data Foundation'))
                        payment_dict['df_payment_type_id'] = generate_uuid(
                            str(payment_dict['df_payment_type_id'] or '') + 
                            str(payment_dict['df_payment_type_id'] or ''), 
                            df_payment_type_id
                        )
                        session.execute(text("SET FOREIGN_KEY_CHECKS = 0;"))
                        fk_flag = 0
                        asyncio.create_task(log_msg(common_logger,log_messages='FK disabled'))
                    else:
                        asyncio.create_task(log_msg(common_logger,log_messages='payment type exists in Data Foundation'))
                        payment_dict['df_payment_type_id']=self_payment_type.df_payment_type_id    
                    
                    if(self_payment_status is None):
                        asyncio.create_task(log_msg(common_logger,log_messages='payment status does not exist in Data Foundation'))
                        payment_dict['df_payment_status_id'] = generate_uuid(
                            str(payment_dict['df_payment_status_id'] or '') + 
                            str(payment_dict['df_payment_status_id'] or ''), 
                            df_payment_status_id
                        )
                        session.execute(text("SET FOREIGN_KEY_CHECKS = 0;"))
                        fk_flag = 0
                        asyncio.create_task(log_msg(common_logger,log_messages='FK disabled'))
                    else:
                        asyncio.create_task(log_msg(common_logger,log_messages='payment type exists in Data Foundation'))
                        payment_dict['df_payment_status_id']=self_payment_status.df_payment_status_id    
                    if (self_payment is None):
                        asyncio.create_task(log_msg(common_logger,log_messages='Payment does not exist in Data Foundation'))
                        asyncio.create_task(log_msg(common_logger,log_messages='Payment dict Insert',api_response=convert_timestamps(payment_dict)))
                        session.add(Payment.from_dict(cls=Payment, d=payment_dict))
                        session.commit()
                        if fk_flag == 0:
                            session.execute(text("SET FOREIGN_KEY_CHECKS = 1;"))
                            session.commit()
                            fk_flag = 1
                            asyncio.create_task(log_msg(common_logger,log_messages='FK enabled'))
                        asyncio.create_task(log_msg(common_logger,log_messages=f'Inserted to DB @ {now} | {datetime.timestamp(now)}'))
                    else:
                        asyncio.create_task(log_msg(common_logger,log_messages='Payment exists in Data Foundation'))
                        asyncio.create_task(log_msg(common_logger,log_messages='Payment dict Update',api_response=convert_timestamps(payment_dict)))
                        payment_dict.update(query_update_dict(obj=Payment, dict=payment_dict))
                        asyncio.create_task(log_msg(common_logger,log_messages=f'Updated in DB @ {now} | {datetime.timestamp(now)}')) 
            else:
                    error_log = {
                        "df_payment_id" : id,
                        "error_message" : "No record found after lookup" 
                    }
                    asyncio.create_task(log_msg(common_logger,log_messages='No record found after lookup'))
        now = datetime.now()
        end_timestamp = datetime.timestamp(now)
        asyncio.create_task(log_msg(common_logger,log_messages=f'execution_time: {end_timestamp} - {start_timestamp}'))
    except SQLAlchemyError as e:
        asyncio.create_task(log_msg(common_logger,log_messages='Error',api_response=e))
        session.rollback()
        raise e


def handle(event, context):
    start_time = time.time()
    print("Handle function is called")
    for record in event['Records']:
        payload = record["body"]
        asyncio.run(consume_lambda(config=payload))
    end_time = time.time()
    return {
        "execution_time_sec": end_time - start_time 
    }

# if __name__ == '__main__':
#     handle({'Records': [{'body': '{"payment_id":"1003093977"}'}]}, None)
 