import os
import json
import time
import requests
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy import text
from df_database_models.db_conn import get_rds_db_session, get_as400_db_session
from df_database_models.models import Agency_Contact_Raw as AgencyContact, Source_System_Raw as Source_System, Carrier
from df_database_models.db_utils import  generate_uuid, convert_timestamps, generate_uuid, query_update_dict, get_record, multi_filter_get_record, push_msg_to_sqs, call_sp
from secrets_manager import get_secret
from datetime import datetime
import pandas as pd
import asyncio
from adf_pyutils.clm_wrapper import common_logger


# logger = logging.getLogger()
# logger.setLevel(logging.INFO)

pnc_db = os.environ['RDS_DB_NAME']
ref_db = os.environ['RDS_REF_DB_NAME']
mdm_raw_db = os.environ['RDS_RAW_DB_NAME']
mdm_refined_db = os.environ['RDS_REFINED_DB_NAME']

## Fetch SQS producer Parameters from aws secret manager

async def log_msg(func,**kwargs):
    await asyncio.to_thread(func,**kwargs)

def msg_to_sqs(source_system=None, identifier=None, id=None):
    if identifier:
        Json_payload = {}
        sqs_queue_prefix = os.environ["SQS_APP_PREFIX"]

        if identifier ==  'Agency':            
            sqs_queue_suffix = os.environ["SQS_AGENCY_SUFFIX"]
            Json_payload["source_agency_id"] = id

        elif identifier ==  'Agency_Contact':
            sqs_queue_suffix = os.environ["SQS_AGENCYCONTACT_SUFFIX"]
            Json_payload["source_agency_contact_id"] = id

        elif identifier ==  'Customer':
            sqs_queue_suffix = os.environ["SQS_CUSTOMER_SUFFIX"]
            Json_payload["source_customer_id"] = id

        elif identifier ==  'Customer_Contact':
            sqs_queue_suffix = os.environ["SQS_CUSTOMERCONTACT_SUFFIX"]
            Json_payload["source_customer_contact_id"] = id

        elif identifier ==  'Mdm_Customer_Sub_Xref':
            sqs_queue_suffix = os.environ["SQS_CUSTOMER_SUB_XREF_SUFFIX"]
            Json_payload = id

        Json_payload['source_system'] = source_system
        queue_name = sqs_queue_prefix+'-'+sqs_queue_suffix

        try:
            response = push_msg_to_sqs(queue_name, Json_payload)
            asyncio.create_task(log_msg(common_logger,log_messages=f'-- Push message to Queue: {queue_name} is success with response code -- {response}'))

        except Exception as e:
            asyncio.create_task(log_msg(common_logger,log_messages=f'-- Push message to Queue: {queue_name} is failed with response code -- {response} -- {e}'))

def init_sp(source_system=None, identifier=None, id=None):
    if identifier:
        sqs_producer_secret = json.loads(get_secret(
                secret_name=os.environ["SQS_PRODUCER_SECRET_ID"], region_name=os.environ["AWS_REGION"]))
        sqs_producer_access_key = sqs_producer_secret["access_key"]

        json_payload = {}

        if identifier ==  'Agency':
            sqs_producer_url = os.environ["SQS_MDM_AGENCY_URL"]
            json_payload["source_agency_id"] = id

        elif identifier ==  'Agency_Contact':
            sqs_producer_url = os.environ["SQS_MDM_AGENCY_CONTACT_URL"]
            json_payload["source_agency_contact_id"] = id

        elif identifier ==  'Customer':
            sqs_producer_url = os.environ["SQS_MDM_CUSTOMER_URL"]
            json_payload["source_customer_id"] = id

        elif identifier ==  'Customer_Contact':
            sqs_producer_url = os.environ["SQS_MDM_CUSTOMER_CONTACT_URL"]
            json_payload["source_customer_contact_id"] = id

        elif identifier ==  'Mdm_Customer_Sub_Xref':
            sqs_producer_url = os.environ["SQS_MDM_CUSTOMER_SUB_XREF_URL"]
            json_payload = id
            

        json_payload['source_system'] = source_system
        try:
            response = call_sp(sqs_producer_url,sqs_producer_access_key, json_payload)
            if str(response) == 200:
                asyncio.create_task(log_msg(common_logger,log_messages=f'-- Calling to Producer API URL: {sqs_producer_url} was success -- {response}'))

        except Exception as e:
            asyncio.create_task(log_msg(common_logger,log_messages=f'-- Calling to Producer API URL : {sqs_producer_url} was failed -- {e}'))

def call_session_engine(source_system=None, database_name=None):

    rds_secret_name=os.environ["RDS_SECRETS_MANAGER_ID"]
    region_name=os.environ["AWS_REGION"]
    rds_host_nm=os.environ['RDS_HOST']

    if database_name == 'ref_data':
        rds_db_nm=os.environ['RDS_REF_DB_NAME']
    elif database_name == 'mdm_raw':
        rds_db_nm=os.environ['RDS_RAW_DB_NAME']
    elif database_name == 'mdm_refined':
        rds_db_nm=os.environ['RDS_REFINED_DB_NAME']
    else:
        rds_db_nm=os.environ['RDS_DB_NAME']


    if source_system.lower() == 'as400_aff':
        #Calling the as400 engine to establish a connection to PAS Source System - as400_AFF
        as400_secret_name=os.environ["AS400_AFF_SECRETS_MANAGER_ID"]
        as400_engine=get_as400_db_session(as400_secret_name, region_name)
        return as400_engine

    elif source_system.lower() == 'as400_kkins':
        #Calling the as400 engine to establish a connection to PAS Source System - as400_AUM
        as400_secret_name=os.environ["AS400_KKINS_SECRETS_MANAGER_ID"]
        as400_engine=get_as400_db_session(as400_secret_name, region_name)
        return as400_engine

    if database_name:
        #Calling the Db session Object to establish a connection to Data Foundation Schema
        session=get_rds_db_session(rds_secret_name,region_name,rds_host_nm,rds_db_nm)

        return session
    
session = call_session_engine(database_name=pnc_db)
as400_engine_aff = call_session_engine(source_system='as400_aff')
as400_engine_kkins = call_session_engine(source_system='as400_kkins')

# lookup into as400 aff
def lookup_as400(config=None, id=None):

    source_system = config['source_system']
    if source_system:
        if(source_system.lower() == 'as400_affprd'):
                df = pd.read_sql(f"""
                    SELECT MCCR_COMPANY_CODE AS source_carrier_id
                    ,COFL01 AS carrier_name
                    ,'AS400_AFFPRD' AS source_system
                    FROM ADGDTAPR.NSPSRCP
                    WHERE MCCR_COMPANY_CODE = '{id}'
                    """, con=as400_engine)

        elif(source_system.lower() == 'as400_attorney'):
                df = pd.read_sql(f"""
                    SELECT CNVPRD AS source_carrier_id,CNVDSC AS carrier_name,'AS400_AFFPRD' as source_system
                    FROM LAWDTAPR.ATACNVP;
                    WHERE CNVPRD = '{id}'
                    """, con=as400_engine)

        elif(source_system.lower() == 'as400_kkins'):
                df = pd.read_sql(f"""
                    SELECT DISTINCT CONCAT(KKPREF, CONCAT('-', KKCODE)) AS source_carrier_id
                    ,KKDESC AS carrier_name
                    FROM USERLIB.KKMISC WHERE KKPREF = 'PCM'
                    AND CONCAT(KKPREF, '-', KKCODE) = '{id}'
                    """, con=as400_engine)
    else:
        df=None

    if(len(df)>0):
        return df.to_dict('records')[0]
    else:
        return None


async def consume_lambda(config=None):
    asyncio.create_task(log_msg(common_logger,log_messages='consume lambda function invoking'))
    now = datetime.now()
    start_timestamp = datetime.timestamp(now)
    asyncio.create_task(log_msg(common_logger,log_messages=f'Processing to DB @ {now} | {datetime.timestamp(now)}'))

    try:
        asyncio.create_task(log_msg(common_logger,log_messages='Config',api_response=convert_timestamps(config)))
        config_dicts = config if type(config) is dict else json.loads(str(config))
        if type(config_dicts) == list:
            pass
        else:
            config_dicts = [config_dicts] # Ensure config_dicts is a list
        for config_dict in config_dicts:
            carrier_id = config_dict['source_carrier_id'] # Get the carrier from config data 
            source_system = config_dict['source_system'].lower()
            if(id):
                fk_flag = 1
                global as400_engine
                source_system = config['source_system'].lower()
                if source_system == 'as400_aff':
                    session = session
                    as400_engine = as400_engine_aff
                elif source_system == 'as400_kkins':
                    session = session
                    as400_engine = as400_engine_kkins

                as400_carrier_summary_dict = lookup_as400(config_dict, carrier_id) #define dict for lookup data
                
                if(as400_carrier_summary_dict):
                    asyncio.create_task(log_msg(common_logger,log_messages=f'Initial {source_system} Carrier Summary dict:',api_response=convert_timestamps(as400_carrier_summary_dict)))

                    #Fetch Source SyStem Id from Data Foundation
                    source_system = as400_carrier_summary_dict.get("source_system")
                    source_system_record = (query.first() if (query := multi_filter_get_record(session,model=Source_System,source_system=source_system)) is not None else None)

                    if source_system_record:
                        as400_carrier_summary_dict['df_source_system_id'] = source_system_record.df_source_system_id

                    source_carrier_id = as400_carrier_summary_dict.get("source_carrier_id")
                    df_source_system_id = as400_carrier_summary_dict.get("df_source_system_id")

                    carrier_record = multi_filter_get_record(session,model = Carrier, source_carrier_id = source_carrier_id, source_system_id = df_source_system_id)
                    self_carrier = (carrier_record.first() if carrier_record is not None else None)

                    asyncio.create_task(log_msg(common_logger,log_messages=f'self agency - {self_carrier}'))
                    asyncio.create_task(log_msg(common_logger,log_messages=f'Changed {source_system} Agency Contact Summary dict:',api_response=convert_timestamps(as400_carrier_summary_dict)))

                    if self_carrier is None:
                        asyncio.create_task(log_msg(common_logger,log_messages='Customer does not exist in Data Foundation'))
                        as400_carrier_summary_dict['df_carrier_id'] = generate_uuid(
                            str(as400_carrier_summary_dict['source_carrier_id'] or '') + 
                            str(as400_carrier_summary_dict['df_source_system_id'] or ''), 
                            df_source_system_id
                        )
                        asyncio.create_task(log_msg(common_logger,log_messages=f'Insert {source_system} Carrier Summary dict: ',api_response=convert_timestamps(as400_carrier_summary_dict)))
                        session.add(Carrier.from_dict(cls = Carrier, d = as400_carrier_summary_dict))
                        session.commit()
                        fk_flag = 0
                        asyncio.create_task(log_msg(common_logger,log_messages='Inserted carrier {carrier_id}'))
                    else:
                        asyncio.create_task(log_msg(common_logger,log_messages='carrier exists in Data foundation schema'))
                        as400_carrier_summary_dict['df_carrier_id'] = self_carrier.df_carrier_id
                        asyncio.create_task(log_msg(common_logger,log_messages='Carrier exists in Data Foundation'))
                        carrier_record.update(query_update_dict( obj = Carrier, dict = as400_carrier_summary_dict))
                        asyncio.create_task(log_msg(common_logger,log_messages=f'Updated in DB @ {now} | {datetime.timestamp(now)}'))
                        session.commit()

                    error_log = {
                        "df_line_item_id" : id,
                        "error_message" : "No record found after lookup" 
                    }
                    asyncio.create_task(log_msg(common_logger,log_messages='No record found after lookup'))
        now = datetime.now()
        end_timestamp = datetime.timestamp(now)
        asyncio.create_task(log_msg(common_logger,log_messages=f'execution_time: {end_timestamp} - {start_timestamp}'))
    except SQLAlchemyError as e:
        asyncio.create_task(log_msg(common_logger,log_messages='Error',api_response=e))
        session.rollback()
        raise e

def handle(event, context):
    start_time = time.time()

    print("Handle function is called")
    for record in event['Records']:
        payload = record["body"]
        asyncio.run(consume_lambda(config=payload))

    end_time = time.time()

    return {
        "execution_time_sec": end_time - start_time 
    }


if __name__ == '__main__':
    handle({'Records': [{'body': '{"source_agency_contact_id":"1003093977"}'}]}, None)
    # handle({'Records': [{'body': '[{ "source_agency_id": "2002569486", "parent_agency_id": "2002254485", "agency_type": "renewal"}]'}]}, None)
    # handle({'Records': [{'body': '[{"source_agency_id":"2002573640"},{"source_agency_id":"2002573647"},{"source_agency_id":"2002573649"}]'}]}, None)
























import os
import json
import time
import asyncio
import pandas as pd
from datetime import datetime
from sqlalchemy import text
from sqlalchemy.exc import SQLAlchemyError

from df_database_models.db_conn import get_rds_db_session, get_as400_db_session
from df_database_models.models import Line_Item, Line_Item_Type, Invoice, Source_System
from df_database_models.db_utils import generate_uuid, query_update_dict, get_record, convert_timestamps
from adf_pyutils.clm_wrapper import common_logger
from secrets_manager import get_secret

print("AS400 LineItem ETL job executing...")

# --- AWS secret configs for DB ---
rds_secret_name = os.environ["RDS_SECRETS_MANAGER_ID"]
region_name = os.environ["AWS_REGION"]
rds_host = os.environ["RDS_HOST"]
rds_db = os.environ["RDS_DB_NAME"]

session = get_rds_db_session(rds_secret_name, region_name, rds_host, rds_db)

async def log_msg(func, **kwargs):
    await asyncio.to_thread(func, **kwargs)

def call_session_engine(source_system=None, identifier=None):

    if source_system:
        rds_secret_name=os.environ["RDS_SECRETS_MANAGER_ID"]
        region_name=os.environ["AWS_REGION"]
        rds_host_nm=os.environ['RDS_HOST']

        if identifier == 'ref':
            rds_db_nm=os.environ['RDS_REF_DB_NAME']
        elif identifier == 'raw':
            rds_db_nm=os.environ['RDS_RAW_DB_NAME']
        elif identifier == 'refined':
            rds_db_nm=os.environ['RDS_REFINED_DB_NAME']
        else:
            rds_db_nm=os.environ['RDS_DB_NAME']

        if source_system.lower() == '':#Type of system to enter is as400 has types
            #Calling the as400 engine to establish a connection to PAS Source System - AS400

            as400_secret_name=os.environ["as400_aff"]#enter secret manager id
            as400_engine=get_as400_db_session(as400_secret_name, region_name)

        elif source_system.lower() == '':
            #Calling the as400 engine to establish a connection to PAS Source System - AS400
            as400_secret_name=os.environ["as400_aum"]#enter secret manager id
            as400_engine=get_as400_db_session(as400_secret_name, region_name)

        #Calling the Db session Object to establish a connection to Data Foundation Schema
        session=get_rds_db_session(rds_secret_name,region_name,rds_host_nm,rds_db_nm)

        return session, as400_engine

# --- Lookup LineItem from AS400 (replace with pyodbc/ibm_db SQL fetch) ---
def lookup_as400_lineitem(config=None, id=None):
    source_system = config['source_system']
    if source_system:
        if source_system.lower() in []:# Add source system
            df = pd.read_sql(f"""
                    SELECT DISTINCT 
                    da.customer_number || '-' || da.effective_date || '-' || cast(da.invoice_no AS varchar(10)) AS source_invoice_id
                    ,cov.BASE_PREMIUM 
                    ,cov.TAX 
                    ,da.commission_amount
                    ,CASE WHEN ds.total_discount !=0 THEN ds.total_discount
                        WHEN dis.discount_percentage !=0 THEN (cov.TOTAL_PREMIUM/dis.discount_percentage)*100 
                        ELSE COALESCE(ds.total_discount,(cov.TOTAL_PREMIUM/dis.discount_percentage)*100) END AS Discount
                    FROM 
                    (
                    (SELECT DISTINCT ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0') AS customer_number,INVOICE_NO
                    ,SUM(PREMIUM) AS premium,sum(commission_amount) AS commission_amount
                    ,CASE	WHEN length(trim(EFFECTIVE_DATE_6)) = 1 THEN NULL
                            WHEN length(trim(EFFECTIVE_DATE_6)) =  5 THEN '20'||substring(trim(EFFECTIVE_DATE_6),4,2) || '0' ||
                            substring(trim(EFFECTIVE_DATE_6),1,1) || substring(trim(EFFECTIVE_DATE_6),2,2)   
                            ELSE '20'||substring(trim(EFFECTIVE_DATE_6),5,2) || 
                            substring(trim(EFFECTIVE_DATE_6),1,2) || substring(trim(EFFECTIVE_DATE_6),3,2) 
                            END AS effective_date 
                    FROM 
                    ADGDTAPR."U.ARFILE"
                    GROUP BY ASSURED_NO || LPAD(ASSURED_SUB_NO,3,'0'),INVOICE_NO,EFFECTIVE_DATE_6
                    ) AS da
                    INNER JOIN 
                    (
                    SELECT 
                    CUSTOMER_NO,EFFECTIVE_DATE,ACCOUNT_NO,BASE_PREMIUM,TOTAL_PREMIUM,POLICY_EFF_DATE,INVOICE_NO
                    ,(STATE_TAX + TOWN_TAX + COUNTY_TAX ) AS tax ,LAST_PAYMENT_DATE
                    FROM ADGDTAPR.NSOCVGP
                    ) AS cov 
                    ON cov.CUSTOMER_NO =da.customer_number AND cov.EFFECTIVE_DATE = da.effective_date
                    AND cov.invoice_no = da.invoice_no
                    LEFT JOIN 
                    (SELECT GRCUST AS customer_no
                    ,GRDISP AS discount_percentage
                    ,GRPEFF AS effective_date
                    ,GRSEQN AS seq_no
                    FROM ADGDTAPR.HCPGRDCP) AS dis -- graduate discount
                    ON dis.customer_no = da.customer_number AND dis.effective_date = da.effective_date
                    LEFT JOIN 
                    (SELECT customer_number,cvg_effective_date AS effective_date,total_discount
                    FROM ADGDTAPR.ADGDSRP) AS ds
                    ON ds.customer_number = da.customer_number AND ds.effective_date = da.effective_date
                    ) 
                    """, con=as400_engine)
        else:
            df=None
    else:
        df=None

    if(len(df)>0):
        return df.to_dict('records')[0]
    else:
        return None


# --- Core Lambda Consumer ---
async def consume_lambda(config=None):
    try:
        asyncio.create_task(log_msg(common_logger,log_messages='consume lambda function invoking'))
        now = datetime.now()
        start_timestamp = datetime.timestamp(now)
        asyncio.create_task(log_msg(common_logger,log_messages=f'Processing to DB @ {now} | {datetime.timestamp(now)}'))
        asyncio.create_task(log_msg(common_logger,log_messages='Config',api_response=convert_timestamps(config)))
        config_dicts = config if type(config) is dict else json.loads(str(config))
        if type(config_dicts) == list:
            pass
        else:
            config_dicts = [config_dicts] # Ensure config_dicts is a list
        for config_dict in config_dicts:
            line_item_id = config_dict["line_item"]
            source_system = config_dict["source_system"]
            global session, as400_engine
            session, as400_engine = call_session_engine(source_system=source_system)

            asyncio.create_task(log_msg(common_logger, log_messages=f"Fetching line_item {line_item_id} from {source_system}"))

            as400_lineitem = lookup_as400_lineitem(source_system, line_item_id)
            if as400_lineitem:


                # --- Map Source_System ---
                source_system_record = (query.first() if (query := get_record(
                    session, model=Source_System, column_name="source_system", value=source_system)) is not None else None)
                if source_system_record:
                    as400_lineitem["df_source_system_id"] = source_system_record.df_source_system_id

                # --- Map LineItem_Type ---
                line_item_type = as400_lineitem.get("source_line_item_type")
                line_item_type_record = (query.first() if (query := get_record(
                    session, model=Line_Item_Type, column_name="line_item_type", value=line_item_type)) is not None else None)
                if line_item_type_record:
                    as400_lineitem["df_line_item_type_id"] = line_item_type_record.df_line_item_type_id

                # --- Invoice ---
                invoice_record = get_record(session, model=Invoice,
                                            column_name="source_invoice_id",
                                            value=as400_lineitem["source_invoice_id"],
                                            df_source_system_id=as400_lineitem["df_source_system_id"])
                self_invoice = invoice_record.first() if invoice_record else None

                if not self_invoice:
                    as400_lineitem["df_invoice_id"] = generate_uuid(
                        str(as400_lineitem["source_invoice_id"]) + str(as400_lineitem.get("invoice_number", "")),
                        as400_lineitem["df_source_system_id"]
                    )
                else:
                    as400_lineitem["df_invoice_id"] = self_invoice.df_invoice_id

                # --- LineItem ---
                lineitem_record = get_record(session, model=Line_Item,
                                            column_name="df_line_item_id",
                                            value=as400_lineitem["df_line_item_id"],
                                            df_source_system_id=as400_lineitem["df_source_system_id"])
                self_lineitem = lineitem_record.first() if lineitem_record else None

                if not self_lineitem:
                    session.add(Line_Item.from_dict(cls=Line_Item, d=as400_lineitem))
                    asyncio.create_task(log_msg(common_logger, log_messages=f"Inserted new LineItem {line_item_id}"))
                else:
                    self_lineitem.update(query_update_dict(obj=Line_Item, dict=as400_lineitem))
                    asyncio.create_task(log_msg(common_logger, log_messages=f"Updated LineItem {line_item_id}"))

                session.commit()
                error_log = {
                        "df_line_item_id" : id,
                        "error_message" : "No record found after lookup" 
                    }
                asyncio.create_task(log_msg(common_logger,log_messages='No record found after lookup'))
        now = datetime.now()
        end_timestamp = datetime.timestamp(now)
        asyncio.create_task(log_msg(common_logger,log_messages=f'execution_time: {end_timestamp} - {start_timestamp}'))

    except SQLAlchemyError as e:
        session.rollback()
        asyncio.create_task(log_msg(common_logger, log_messages="DB Error", api_response=str(e)))
        raise e

def handle(event, context):
    start_time = time.time()
    for record in event["Records"]:
        payload = record["body"]
        asyncio.run(consume_lambda(config=payload))
    return {"execution_time_sec": time.time() - start_time}
